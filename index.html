<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-Depth Performance Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Fallback background gradient */
            background: linear-gradient(to right, #000428, #004e92);
        }
        #bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -2;
            filter: blur(2px) brightness(0.7);
        }
        #bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }
        .chart-container {
            position: relative;
            margin: auto;
            height: 45vh;
            width: 100%;
        }
        .error-row {
            background-color: #fee2e2; /* red-100 */
        }
        .error-row:hover {
            background-color: #fecaca; /* red-200 */
        }
        .threshold-exceeded-row {
            background-color: #fef9c3; /* yellow-100 */
        }
        .threshold-exceeded-row:hover {
            background-color: #fef08a; /* yellow-200 */
        }
        .summary-card {
            transition: all 0.3s ease-in-out;
            animation: fadeIn 0.5s ease-in-out;
            background-color: rgba(255, 255, 255, 0.9);
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .content-card {
             background-color: rgba(255, 255, 255, 0.9);
        }
        .assistant-tip {
            display: none; /* Hidden by default */
            background-color: #e0f2fe; /* light-blue-100 */
            border-left: 4px solid #0ea5e9; /* sky-500 */
            padding: 0.75rem;
            margin-top: 1rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #0c4a6e; /* sky-800 */
        }
        .assistant-tip.visible {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-200">

    <video id="bg-video" autoplay loop muted playsinline>
        <!-- Using a placeholder video of a container ship -->
        <source src="https://assets.mixkit.co/videos/preview/mixkit-container-ship-sailing-in-the-ocean-3563-large.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div id="bg-overlay"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative z-10">
        <header class="text-center mb-8 pt-16">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">In-Depth Performance Analysis Dashboard</h1>
            <p class="text-md text-gray-300 mt-2">Upload a results file (.jmx, .csv, .json) to explore performance data.</p>
        </header>

        <!-- Main Action Section -->
        <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 items-center mb-8">
            <!-- File Upload Section -->
            <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                <label for="file-upload-label" class="block text-lg font-semibold text-gray-800 mb-2">Upload Results File(s)</label>
                <div class="flex items-center justify-center w-full">
                    <label id="file-upload-label" for="file-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-400 border-dashed rounded-lg cursor-pointer bg-gray-200 hover:bg-gray-300 transition">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="mb-2 text-sm text-gray-600"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-gray-600">Supports .jmx, .csv, .json files</p>
                        </div>
                        <input id="file-upload" type="file" class="hidden" accept=".jmx,.csv,.json" multiple />
                    </label>
                </div>
                <p id="file-name" class="mt-4 text-center text-sm text-gray-700"></p>
            </div>

            <!-- Understand Chart Button Section -->
             <div class="content-card text-center p-6 rounded-lg shadow-md border border-gray-700 flex flex-col items-center justify-center h-full">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Need help reading the charts?</h3>
                <p class="text-gray-700 mb-6 text-center">Click the button below for a detailed guide on how to interpret the performance data.</p>
                <button id="understand-chart-btn" class="bg-teal-500 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-teal-600 transition transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                    Understand The Charts
                </button>
            </div>
        </div>


        <!-- Filters Section -->
        <div id="filters-section" class="max-w-4xl mx-auto content-card rounded-lg shadow-md p-6 border border-gray-700 mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">Data Filters & Export</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="label-filter" class="block text-sm font-medium text-gray-900">Filter by Label</label>
                    <select id="label-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-gray-900"></select>
                </div>
                <div>
                    <label for="status-filter" class="block text-sm font-medium text-gray-900">Filter by Status</label>
                    <select id="status-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-gray-900">
                        <option value="all">All</option>
                        <option value="true">Success</option>
                        <option value="false">Failure</option>
                    </select>
                </div>
                <div>
                    <label for="threshold-input" class="block text-sm font-medium text-gray-900">Response Time Threshold (ms)</label>
                    <input type="number" id="threshold-input" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-gray-900" placeholder="e.g., 2000">
                </div>
                <div class="flex items-end">
                    <button id="apply-filters-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Apply</button>
                </div>
            </div>
             <div class="mt-4 flex justify-between items-center">
                <button id="export-pdf-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Export PDF</button>
                <div class="flex items-center ml-4">
                    <label for="toggle-tips" class="mr-2 text-sm font-medium text-gray-900">Show Assistant Tips</label>
                    <input type="checkbox" id="toggle-tips" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                </div>
            </div>
        </div>

        <!-- Data Display Section -->
        <div id="dashboard-content" class="mt-10 hidden">
            <!-- Performance Summary Cards -->
            <div id="summary-stats" class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center mb-8"></div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 gap-8 mb-8 text-gray-800">
                <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center">Response Time Over Time (by Label)</h2>
                        <button onclick="downloadChart('response-time-over-time-chart', 'response-time-over-time.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm">Save PNG</button>
                    </div>
                    <div id="response-time-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="response-time-over-time-chart"></canvas></div>
                </div>
                <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center">Throughput (Requests/sec)</h2>
                        <button onclick="downloadChart('throughput-chart', 'throughput.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm">Save PNG</button>
                    </div>
                     <div id="throughput-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="throughput-chart"></canvas></div>
                </div>
                 <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center">90th/95th Percentiles by Label</h2>
                        <button onclick="downloadChart('percentile-chart', 'percentiles.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm">Save PNG</button>
                    </div>
                     <div id="percentile-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="percentile-chart"></canvas></div>
                </div>
                 <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4 w-full">
                        <h2 class="text-xl font-semibold text-center">Error Distribution by Label</h2>
                        <button onclick="downloadChart('error-rate-chart', 'error-distribution.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm">Save PNG</button>
                    </div>
                    <div id="error-rate-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="error-rate-chart"></canvas></div>
                </div>
                 <div class="content-card rounded-lg shadow-md p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-center">Success vs. Failure Trend</h2>
                        <button onclick="downloadChart('success-fail-trend-chart', 'success-fail-trend.png')" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 text-sm">Save PNG</button>
                    </div>
                    <div id="success-fail-trend-tip" class="assistant-tip"></div>
                    <div class="chart-container"><canvas id="success-fail-trend-chart"></canvas></div>
                </div>
            </div>

            <!-- Detailed Table Section -->
            <div class="content-card rounded-lg shadow-md border border-gray-700 overflow-hidden text-gray-800">
                 <div class="flex justify-between items-center p-6">
                     <h2 class="text-2xl font-semibold">Detailed Data</h2>
                     <button id="download-csv-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 text-sm">Download CSV</button>
                 </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Label</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (ms)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Time</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="pagination-controls" class="px-6 py-3 flex items-center justify-between border-t border-gray-200"></div>
            </div>
        </div>
        <div id="no-data-message" class="text-center mt-10 p-6 content-card rounded-lg shadow-md border border-gray-700 hidden">
            <p class="text-gray-600">No valid data found in the uploaded file.</p>
        </div>
    </div>

    <!-- Modal for Maximized Chart -->
    <div id="chart-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full h-full max-w-6xl max-h-[90vh] relative">
            <button id="close-modal-btn" class="absolute top-2 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold">&times;</button>
            <canvas id="maximized-chart-canvas"></canvas>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        const fileUpload = document.getElementById('file-upload');
        const fileUploadLabel = document.getElementById('file-upload-label');
        const fileNameDisplay = document.getElementById('file-name');
        const dashboardContent = document.getElementById('dashboard-content');
        const noDataMessage = document.getElementById('no-data-message');
        const filtersSection = document.getElementById('filters-section');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const understandChartBtn = document.getElementById('understand-chart-btn');
        const chartModal = document.getElementById('chart-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const maximizedChartCanvas = document.getElementById('maximized-chart-canvas');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        const toggleTipsCheckbox = document.getElementById('toggle-tips');

        let allData = [];
        let filteredData = [];
        let charts = {};
        let maximizedChart;
        let currentPage = 1;
        const rowsPerPage = 20;

        // --- EVENT LISTENERS ---
        fileUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                handleFile(files[0]); 
            }
        });

        fileUploadLabel.addEventListener('dragover', (event) => {
            event.preventDefault();
            event.stopPropagation();
            fileUploadLabel.classList.add('bg-gray-300');
        });

        fileUploadLabel.addEventListener('dragleave', (event) => {
            event.preventDefault();
            event.stopPropagation();
            fileUploadLabel.classList.remove('bg-gray-300');
        });

        fileUploadLabel.addEventListener('drop', (event) => {
            event.preventDefault();
            event.stopPropagation();
            fileUploadLabel.classList.remove('bg-gray-300');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        understandChartBtn.addEventListener('click', () => {
            const docUrl = 'https://docs.google.com/document/d/1qYJSSj4mu_j538lk0DOD3m_M28AFUUZQgnyX25FQwz0/edit?usp=sharing';
            window.open(docUrl, '_blank');
        });

        closeModalBtn.addEventListener('click', () => {
            chartModal.classList.add('hidden');
            if (maximizedChart) {
                maximizedChart.destroy();
            }
        });

        chartModal.addEventListener('click', (event) => {
            if (event.target === chartModal) {
                 chartModal.classList.add('hidden');
                 if (maximizedChart) {
                    maximizedChart.destroy();
                }
            }
        });

        exportPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });

            pdf.setFontSize(18);
            pdf.text('Performance Analysis Report', 10, 15);

            pdf.setFontSize(12);
            const summary = calculateSummaryMetrics(filteredData);
            let summaryText = `
                Total Requests: ${summary.totalRequests}
                Total Errors: ${summary.totalErrors}
                Avg Response Time: ${summary.avgTime.toFixed(2)} ms
                Max Response Time: ${summary.maxTime} ms
                Peak Throughput: ${summary.peakThroughput.toFixed(2)} req/s
                Threshold Breaches: ${summary.thresholdBreaches}
            `;
            pdf.text(summaryText, 10, 25);

            const chartElements = document.querySelectorAll('.chart-container canvas');
            let y = 70;

            for (const canvas of chartElements) {
                if (canvas.parentElement.parentElement.style.display !== 'none') {
                    const imgData = canvas.toDataURL('image/png', 1.0);
                    const chartHeight = 100;
                    const chartWidth = 180;
                    if (y + chartHeight > 280) {
                        pdf.addPage();
                        y = 10;
                    }
                    pdf.addImage(imgData, 'PNG', 10, y, chartWidth, chartHeight);
                    y += chartHeight + 10;
                }
            }
            pdf.save('performance_report.pdf');
        });

        toggleTipsCheckbox.addEventListener('change', (event) => {
            const tips = document.querySelectorAll('.assistant-tip');
            if (event.target.checked) {
                tips.forEach(tip => tip.classList.add('visible'));
            } else {
                tips.forEach(tip => tip.classList.remove('visible'));
            }
        });

        function handleFile(file) {
            fileNameDisplay.textContent = `Processing: ${file.name}... (Note: Multi-file comparison coming soon!)`;
            const reader = new FileReader();
            
            reader.onload = (e) => {
                const worker = new Worker(URL.createObjectURL(new Blob([`
                    (${workerFunction.toString()})()
                `], { type: 'application/javascript' })));

                worker.onmessage = (event) => {
                    if (event.data.error) {
                        handleError(new Error(event.data.error));
                    } else {
                        allData = event.data.sort((a, b) => a.timestamp - b.timestamp);
                        fileNameDisplay.textContent = `File: ${file.name}`;
                        initializeDashboard();
                    }
                    worker.terminate();
                };
                
                worker.postMessage({
                    content: e.target.result,
                    fileType: file.name.split('.').pop().toLowerCase()
                });
            };
            reader.readAsText(file);
        }
        
        function workerFunction() {
            self.onmessage = function(event) {
                const { content, fileType } = event.data;
                try {
                    let data;
                    if (fileType === 'jmx') data = parseJMX(content);
                    else if (fileType === 'csv') data = parseCSV(content);
                    else if (fileType === 'json') data = parseJSON(content);
                    else throw new Error('Unsupported file format.');
                    
                    if (data.length === 0) throw new Error('No sample data found.');
                    
                    self.postMessage(data);
                } catch (e) {
                    self.postMessage({ error: e.message });
                }
            };

            function parseJMX(xmlContent) {
                const sampleTags = [...xmlContent.matchAll(/<(httpSample|sample)\s+([^>]+)>/g)];
                
                return sampleTags.map(tagMatch => {
                    const attributesString = tagMatch[2];
                    const attributes = {};
                    
                    const attrRegex = /(\w+)="([^"]*)"/g;
                    let attrMatch;
                    while ((attrMatch = attrRegex.exec(attributesString)) !== null) {
                        attributes[attrMatch[1]] = attrMatch[2];
                    }
                    
                    return {
                        label: attributes['lb'],
                        sampleTime: parseInt(attributes['t'], 10),
                        success: attributes['s'] === 'true',
                        timestamp: parseInt(attributes['ts'], 10),
                    };
                });
            }

            function parseCSV(csvContent) {
                const lines = csvContent.trim().split('\n');
                const header = lines[0].toLowerCase().split(',').map(h => h.trim().replace(/"/g, ''));
                const data = [];
                
                const labelIdx = header.indexOf('label');
                const timeIdx = header.indexOf('elapsed');
                const successIdx = header.indexOf('success');
                const timeStampIdx = header.indexOf('timestamp');

                if (labelIdx === -1 || timeIdx === -1 || successIdx === -1 || timeStampIdx === -1) {
                    throw new Error('Invalid CSV header. Required columns: timeStamp, elapsed, label, success.');
                }

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length < header.length) continue;
                    data.push({
                        timestamp: parseInt(values[timeStampIdx].trim(), 10),
                        sampleTime: parseInt(values[timeIdx].trim(), 10),
                        label: values[labelIdx].trim().replace(/"/g, ''),
                        success: values[successIdx].trim().toLowerCase() === 'true',
                    });
                }
                return data;
            }
            function parseJSON(jsonContent) {
                const parsed = JSON.parse(jsonContent);
                if (!Array.isArray(parsed) || !parsed[0] || !('label' in parsed[0])) {
                    throw new Error('Invalid JSON. Expected an array of objects with keys: label, sampleTime, success, timestamp.');
                }
                return parsed;
            }
        }

        function handleError(error) {
            console.error("File processing error:", error);
            fileNameDisplay.textContent = `Error: ${error.message}`;
            dashboardContent.classList.add('hidden');
            filtersSection.classList.add('hidden');
            noDataMessage.classList.remove('hidden');
        }

        // --- DASHBOARD INITIALIZATION & UPDATES ---
        function initializeDashboard() {
            dashboardContent.classList.remove('hidden');
            filtersSection.classList.remove('hidden');
            noDataMessage.classList.add('hidden');
            populateFilters(allData);
            applyFilters();
        }
        
        applyFiltersBtn.addEventListener('click', applyFilters);

        function applyFilters() {
            const labelFilterValue = document.getElementById('label-filter').value;
            const statusFilterValue = document.getElementById('status-filter').value;
            filteredData = allData.filter(item => 
                (labelFilterValue === 'all' || item.label === labelFilterValue) &&
                (statusFilterValue === 'all' || String(item.success) === statusFilterValue)
            );
            currentPage = 1;
            updateDashboard();
        }

        function updateDashboard() {
            if (filteredData.length === 0) {
                noDataMessage.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
                return;
            }
            noDataMessage.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            
            const processed = processDataForCharts(filteredData);
            
            renderSummary(processed.summary);
            renderChart('response-time-over-time-chart', processed.responseTimeSeries);
            renderChart('throughput-chart', processed.throughput);
            renderChart('percentile-chart', processed.percentiles);
            renderChart('error-rate-chart', processed.errorRates);
            renderChart('success-fail-trend-chart', processed.successFailTrend);
            renderTable();
            generateInsights(filteredData, processed);
        }

        // --- DATA PROCESSING ---
        function processDataForCharts(data) {
            const summary = calculateSummaryMetrics(data);
            const responseTimeSeries = getResponseTimeSeries(data);
            const throughput = getThroughput(data);
            const percentiles = getPercentiles(data);
            const errorRates = getErrorRates(data);
            const successFailTrend = getSuccessFailTrend(data);
            return { summary, responseTimeSeries, throughput, percentiles, errorRates, successFailTrend };
        }

        // --- METRIC CALCULATIONS ---
        function calculateSummaryMetrics(data) {
            if (data.length === 0) return {};
            const times = data.map(d => d.sampleTime).filter(t => !isNaN(t));
            if (times.length === 0) return { totalRequests: data.length, totalErrors: data.filter(d => !d.success).length };
            
            const threshold = parseInt(document.getElementById('threshold-input').value, 10) || 0;
            const totalDuration = (data[data.length - 1].timestamp - data[0].timestamp) / 1000;
            const throughputPerSecond = {};
            let thresholdBreaches = 0;

            data.forEach(d => {
                const second = Math.floor(d.timestamp / 1000);
                throughputPerSecond[second] = (throughputPerSecond[second] || 0) + 1;
                if (threshold > 0 && d.sampleTime > threshold) {
                    thresholdBreaches++;
                }
            });

            return {
                totalRequests: data.length,
                totalErrors: data.filter(d => !d.success).length,
                avgTime: times.reduce((a, b) => a + b, 0) / times.length,
                maxTime: Math.max(...times),
                peakThroughput: Math.max(0, ...Object.values(throughputPerSecond)),
                thresholdBreaches: thresholdBreaches
            };
        }

        const CHART_CONFIGS = {
            getResponseTimeSeries: (data) => {
                const datasets = {};
                data.forEach(d => {
                    if (!datasets[d.label]) {
                        datasets[d.label] = {
                            label: d.label,
                            data: [],
                            borderColor: getRandomColor(),
                            tension: 0.1,
                            pointRadius: 1,
                        };
                    }
                    datasets[d.label].data.push({ x: d.timestamp, y: d.sampleTime });
                });
                return { type: 'line', data: { datasets: Object.values(datasets) }, options: getCommonTimeOptions('Response Time (ms)') };
            },
            getThroughput: (data) => {
                const throughputPerSecond = {};
                data.forEach(d => {
                    const second = Math.floor(d.timestamp / 1000) * 1000;
                    throughputPerSecond[second] = (throughputPerSecond[second] || 0) + 1;
                });
                const chartData = Object.entries(throughputPerSecond).map(([ts, count]) => ({ x: parseInt(ts), y: count }));
                return {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Requests/sec',
                            data: chartData,
                            borderColor: '#34d399',
                            fill: true,
                            backgroundColor: 'rgba(52, 211, 153, 0.2)'
                        }]
                    },
                    options: getCommonTimeOptions('Number of Requests')
                };
            },
            getPercentiles: (data) => {
                const byLabel = groupBy(data, 'label');
                const labels = Object.keys(byLabel);
                const p90 = [];
                const p95 = [];
                labels.forEach(label => {
                    const times = byLabel[label].map(d => d.sampleTime).sort((a,b) => a-b);
                    p90.push(times[Math.floor(times.length * 0.9)]);
                    p95.push(times[Math.floor(times.length * 0.95)]);
                });
                return {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: '90th Percentile', data: p90, backgroundColor: 'rgba(96, 165, 250, 0.7)' },
                            { label: '95th Percentile', data: p95, backgroundColor: 'rgba(59, 130, 246, 0.7)' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Response Time (ms)'
                                }
                            }
                        }
                    }
                };
            },
            getErrorRates: (data) => {
                const byLabel = groupBy(data.filter(d => !d.success), 'label');
                const labels = Object.keys(byLabel);
                const errorCounts = labels.map(label => byLabel[label].length);

                return {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Errors',
                            data: errorCounts,
                            backgroundColor: getRandomColor(0.7),
                        }]
                    },
                    options: {
                        indexAxis: 'y', // This makes the bar chart horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Errors'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                };
            },
            getSuccessFailTrend: (data) => {
                const trend = {};
                 data.forEach(d => {
                    const second = Math.floor(d.timestamp / 1000) * 1000;
                    if (!trend[second]) trend[second] = { success: 0, fail: 0 };
                    d.success ? trend[second].success++ : trend[second].fail++;
                });
                const successData = [], failData = [];
                Object.entries(trend).sort((a,b) => a[0] - b[0]).forEach(([ts, counts]) => {
                    successData.push({ x: parseInt(ts), y: counts.success });
                    failData.push({ x: parseInt(ts), y: counts.fail });
                });
                return {
                    type: 'line',
                    data: {
                        datasets: [
                            { label: 'Success', data: successData, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.1 },
                            { label: 'Failure', data: failData, borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.1 }
                        ]
                    },
                    options: getCommonTimeOptions('Number of Requests')
                }
            }
        };

        // --- CHART RENDERING ---
        function renderChart(canvasId, config) {
            if (charts[canvasId]) charts[canvasId].destroy();
            if (config && config.data && config.data.datasets.some(ds => ds.data && ds.data.length > 0)) {
                 const chartWrapper = document.getElementById(canvasId).parentElement.parentElement;
                 chartWrapper.style.display = 'block';
                 charts[canvasId] = new Chart(document.getElementById(canvasId).getContext('2d'), config);
                 
                 // Add double-click listener for maximizing
                 chartWrapper.ondblclick = () => {
                     if (maximizedChart) {
                         maximizedChart.destroy();
                     }
                     chartModal.classList.remove('hidden');
                     maximizedChart = new Chart(maximizedChartCanvas, config);
                 };
            } else {
                 document.getElementById(canvasId).parentElement.parentElement.style.display = 'none';
            }
        }

        function renderSummary(summary) {
            document.getElementById('summary-stats').innerHTML = `
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600">Total Requests</p><p class="text-3xl font-bold text-blue-600">${summary.totalRequests || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600">Total Errors</p><p class="text-3xl font-bold text-red-600">${summary.totalErrors || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600">Avg / Max Response (ms)</p><p class="text-3xl font-bold text-gray-800">${(summary.avgTime || 0).toFixed(0)} / ${summary.maxTime || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600">Peak Throughput (req/s)</p><p class="text-3xl font-bold text-green-600">${summary.peakThroughput || 0}</p></div>
                <div class="summary-card p-4 rounded-lg shadow border"><p class="text-sm text-gray-600">Threshold Breaches</p><p class="text-3xl font-bold text-yellow-600">${summary.thresholdBreaches || 0}</p></div>
            `;
        }

        // --- TABLE & PAGINATION ---
        function renderTable() {
            const tableBody = document.getElementById('resultsTableBody');
            tableBody.innerHTML = '';
            const threshold = parseInt(document.getElementById('threshold-input').value, 10);

            const paginatedData = filteredData.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            paginatedData.forEach((item, index) => {
                const row = document.createElement('tr');
                if (!item.success) {
                    row.classList.add('error-row');
                } else if (threshold && item.sampleTime > threshold) {
                    row.classList.add('threshold-exceeded-row');
                }
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${(currentPage - 1) * rowsPerPage + index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.label}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.sampleTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${item.success ? 'text-green-600' : 'text-red-600'}">${item.success ? 'Success' : 'Failure'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(item.timestamp).toLocaleString('en-US')}</td>
                `;
                tableBody.appendChild(row);
            });
            renderPaginationControls();
        }

        function renderPaginationControls() {
            const container = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            container.innerHTML = '';
            if (totalPages <= 1) return;
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50';
            prevButton.onclick = () => { currentPage--; renderTable(); };
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.className = 'ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50';
            nextButton.onclick = () => { currentPage++; renderTable(); };
            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm text-gray-700';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            const buttonWrapper = document.createElement('div');
            buttonWrapper.appendChild(prevButton);
            buttonWrapper.appendChild(nextButton);
            container.appendChild(pageInfo);
            container.appendChild(buttonWrapper);
        }

        // --- UTILITIES ---
        function populateFilters(data) {
            const labelFilter = document.getElementById('label-filter');
            labelFilter.innerHTML = '<option value="all">All Labels</option>';
            [...new Set(data.map(item => item.label))].forEach(label => {
                const option = document.createElement('option');
                option.value = label;
                option.textContent = label;
                labelFilter.appendChild(option);
            });
        }
        
        const { getResponseTimeSeries, getThroughput, getPercentiles, getErrorRates, getSuccessFailTrend } = CHART_CONFIGS;

        function getCommonTimeOptions(yAxisTitle) {
            return {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, title: { display: true, text: 'Time' } },
                    y: { beginAtZero: true, title: { display: true, text: yAxisTitle } }
                },
                plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 12, padding: 20 } } }
            };
        }

        function groupBy(arr, key) {
            return arr.reduce((acc, item) => {
                (acc[item[key]] = acc[item[key]] || []).push(item);
                return acc;
            }, {});
        }

        function getRandomColor(alpha = 1) {
            const r = Math.floor(Math.random() * 255);
            const g = Math.floor(Math.random() * 255);
            const b = Math.floor(Math.random() * 255);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        downloadCsvBtn.addEventListener('click', () => {
             if (filteredData.length === 0) { alert('No data to download.'); return; }
            const headers = "Timestamp,Label,SampleTime,Success\n";
            const csvContent = filteredData.map(d => `${new Date(d.timestamp).toISOString()},"${d.label}",${d.sampleTime},${d.success}`).join('\n');
            const blob = new Blob([headers + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", "filtered_performance_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function downloadChart(canvasId, filename) {
            const canvas = document.getElementById(canvasId);
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function generateInsights(data, processedData) {
            const tips = {
                'response-time-tip': '',
                'throughput-tip': '',
                'error-rate-tip': '',
            };

            // Response Time Spike
            const avgTime = processedData.summary.avgTime;
            const maxTime = processedData.summary.maxTime;
            if (maxTime > avgTime * 3 && maxTime > 1000) {
                const spike = data.find(d => d.sampleTime === maxTime);
                tips['response-time-tip'] = `⚠️ Response time spiked to ${maxTime}ms for "${spike.label}" at ${new Date(spike.timestamp).toLocaleTimeString()}. This is significantly higher than the average of ${avgTime.toFixed(0)}ms.`;
            }

            // High Error Rate
            const errorRate = (processedData.summary.totalErrors / processedData.summary.totalRequests) * 100;
            if (errorRate > 10) {
                const errorData = processedData.errorRates.data.datasets[0].data;
                const labels = processedData.errorRates.data.labels;
                const maxErrors = Math.max(...errorData);
                const maxErrorLabel = labels[errorData.indexOf(maxErrors)];
                tips['error-rate-tip'] = `🔴 The overall error rate is ${errorRate.toFixed(1)}%, which is high. The most errors occurred in the "${maxErrorLabel}" request.`;
            }

            // Flatline Throughput
            const throughputData = processedData.throughput.data.datasets[0].data;
            if (throughputData.length > 5) {
                const lastFivePoints = throughputData.slice(-5).map(p => p.y);
                const avgLastFive = lastFivePoints.reduce((a, b) => a + b, 0) / 5;
                const deviation = Math.sqrt(lastFivePoints.map(y => Math.pow(y - avgLastFive, 2)).reduce((a, b) => a + b, 0) / 5);
                if (deviation < avgLastFive * 0.1) { // If standard deviation is less than 10% of the average
                    tips['throughput-tip'] = `⚠️ Throughput appears to have capped at around ${avgLastFive.toFixed(0)} req/sec, suggesting a potential system bottleneck.`;
                }
            }
            
            // Render tips
            for (const [id, tip] of Object.entries(tips)) {
                const el = document.getElementById(id);
                if (tip) {
                    el.textContent = tip;
                    el.style.display = 'block';
                } else {
                    el.style.display = 'none';
                }
            }
        }

    </script>

</body>
</html>
